<!DOCTYPE html>
<html>
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CreativeHub - Transcription Audio</title>
    <link rel="icon" href="{{ url_for('static', filename='img/favicon.ico') }}" type="image/x-icon">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/transcription.css') }}">
   
</head>
<body>
    <header class="header">
        <div class="logo">CreativeHub</div>
    </header>
    <main class="main-content">
        <div id="transcription-page" class="tool-page">
            <h2>Transcription Audio Intelligente</h2>
            
            <button id="recordButton" class="record-btn">Commencer l'enregistrement</button>
            
            <input type="file" id="transcriptionAudio" accept="audio/*,video/*">
            <label for="transcriptionAudio" class="upload-label">üìÅ S√©lectionner un fichier audio/vid√©o</label>
            
            <div id="transcription-audio-container"></div>
            
            <div class="output-container">
                <div class="output-section">
                    <h3>Transcription</h3>
                    <textarea id="transcription-output"  placeholder="La transcription appara√Ætra ici..."></textarea>
                </div>
                <div class="output-section">
                    <h3>R√©sum√©</h3>
                    <textarea id="summary-output" readonly placeholder="Le r√©sum√© appara√Ætra ici..." class="hidden"></textarea>
                </div>
                <div class="output-section">
                    <h3>√âl√©ments Cl√©s</h3>
                    <textarea id="items-output" readonly placeholder="Les √©l√©ments cl√©s appara√Ætront ici..." class="hidden"></textarea>
                </div>
            </div>
            
            

            <div class="email-section">
                <h3>R√©diger un email</h3>
                <input type="text" id="emailSubject" class="email-input" placeholder="Objet de l'email">
                <input type="text" id="emailRecipients" class="email-input" placeholder="Destinataires (s√©parer les adresses par des virgules)">
                
                <textarea id="emailContent" class="email-input email-content" placeholder="Contenu de l'email"></textarea>

                <button id="sendEmail" class="use-tool-btn">Envoyer l'email</button>
            </div>
            
            
            <button id="summarize-btn" class="use-tool-btn hidden">Analyser et R√©sumer</button>
            
    </main>

   


    <script>
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let sessionId = null;
        let transcriptionCheckInterval = null;
        let summaryCheckInterval = null;

        // Fonction pour obtenir l'ID de session
        async function getSessionId() {
            try {
                const response = await fetch('/get-session-id', {
                    credentials: 'include'
                });
                const data = await response.json();
                sessionId = data.session_id;
            } catch (error) {
                console.error('Erreur lors de la r√©cup√©ration de l\'ID de session:', error);
            }
        }

        // Appeler getSessionId au chargement de la page
        getSessionId();

        // Gestionnaire pour le bouton d'enregistrement
        const recordButton = document.getElementById('recordButton');
        recordButton.addEventListener('click', toggleRecording);

        async function toggleRecording() {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        await handleAudioFile(audioBlob);
                    };

                    mediaRecorder.start();
                    isRecording = true;
                    recordButton.textContent = 'Arr√™ter l\'enregistrement';
                    recordButton.classList.add('recording');
                } catch (err) {
                    console.error('Erreur lors de l\'acc√®s au microphone:', err);
                    alert('Impossible d\'acc√©der au microphone');
                }
            } else {
                mediaRecorder.stop();
                isRecording = false;
                recordButton.textContent = 'Commencer l\'enregistrement';
                recordButton.classList.remove('recording');
            }
        }

        // Fonction pour g√©rer le fichier audio (enregistrement ou upload)
        async function handleAudioFile(audioBlob) {
            const formData = new FormData();
            formData.append('audio_file', audioBlob, 'audio_input.wav');

            try {
                const transcriptionOutput = document.getElementById('transcription-output');
                transcriptionOutput.value = 'Transcription en cours...';

                const response = await fetch('/transcription', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                if (data.status === 'processing') {
                    startTranscriptionCheck();
                }
            } catch (error) {
                console.error('Erreur:', error);
                transcriptionOutput.value = `Erreur: ${error.message}`;
            }
        }

        // Gestionnaire pour le fichier upload√©
        document.getElementById('transcriptionAudio').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const audioContainer = document.getElementById('transcription-audio-container');
            audioContainer.innerHTML = '';
            const audio = document.createElement('audio');
            audio.controls = true;
            audio.src = URL.createObjectURL(file);
            audioContainer.appendChild(audio);

            const formData = new FormData();
            formData.append('audio_file', file);

            try {
                const transcriptionOutput = document.getElementById('transcription-output');
                transcriptionOutput.value = 'Transcription en cours...';

                const response = await fetch('/transcription', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include' // Important pour maintenir la session
                });
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                if (data.status === 'processing') {
                    startTranscriptionCheck();
                }
            } catch (error) {
                console.error('Erreur:', error);
                transcriptionOutput.value = `Erreur: ${error.message}`;
            }
        });

        // Fonctions pour v√©rifier le statut de la transcription
        function startTranscriptionCheck() {
            if (transcriptionCheckInterval) {
                clearInterval(transcriptionCheckInterval);
            }
            transcriptionCheckInterval = setInterval(checkTranscriptionStatus, 2000);
        }

        async function checkTranscriptionStatus() {
            try {
                const response = await fetch('/check-transcription', {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.status === 'completed') {
                    clearInterval(transcriptionCheckInterval);
                    document.getElementById('transcription-output').value = data.transcription;
                    document.getElementById('summarize-btn').classList.remove('hidden');
                } else if (data.status === 'error') {
                    clearInterval(transcriptionCheckInterval);
                    document.getElementById('transcription-output').value = `Erreur: ${data.error}`;
                }
            } catch (error) {
                console.error('Erreur lors de la v√©rification de la transcription:', error);
            }
        }

        async function summarizeTranscription() {
            const transcriptionText = document.getElementById('transcription-output').value;
            const summaryOutput = document.getElementById('summary-output');
            const itemsOutput = document.getElementById('items-output');

            summaryOutput.classList.remove('hidden');
            itemsOutput.classList.remove('hidden');
            summaryOutput.value = 'Analyse en cours...';
            itemsOutput.value = 'Extraction des √©l√©ments cl√©s...';

            try {
                const response = await fetch('/summarize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        transcription_text: transcriptionText
                    }),
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Mettre √† jour les champs avec les donn√©es re√ßues
                summaryOutput.value = data.summary;
                itemsOutput.value = data.key_elements || 'Aucun √©l√©ment cl√© trouv√©';

                // Remplir automatiquement le contenu de l'email
                document.getElementById('emailContent').value = data.email_content;

              
            } catch (error) {
                summaryOutput.value = `Erreur: ${error.message}`;
                itemsOutput.value = 'Erreur lors de l\'extraction des √©l√©ments cl√©s';
            }
        }


        // Ajouter cet √©v√©nement au bouton de r√©sum√©
        document.getElementById('summarize-btn').addEventListener('click', summarizeTranscription);

        // Fonctions pour v√©rifier le statut du r√©sum√©
        function startSummaryCheck() {
            if (summaryCheckInterval) {
                clearInterval(summaryCheckInterval);
            }
            summaryCheckInterval = setInterval(checkSummaryStatus, 2000);
        }

        async function checkSummaryStatus() {
            try {
                const response = await fetch('/check-summary', {
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.status === 'completed') {
                    clearInterval(summaryCheckInterval);
                    const summaryParts = data.summary.split('\n\n√âl√©ments cl√©s:\n');
                    document.getElementById('summary-output').value = summaryParts[0];
                    document.getElementById('items-output').value = summaryParts[1] || 'Aucun √©l√©ment cl√© trouv√©';
                    
                } else if (data.status === 'error') {
                    clearInterval(summaryCheckInterval);
                    document.getElementById('summary-output').value = `Erreur: ${data.error}`;
                    document.getElementById('items-output').value = 'Erreur lors de l\'extraction des √©l√©ments cl√©s';
                }
            } catch (error) {
                console.error('Erreur lors de la v√©rification du r√©sum√©:', error);
            }
        }

        document.getElementById('sendEmail').addEventListener('click', async function() {
            const recipients = document.getElementById('emailRecipients').value;
            const subject = document.getElementById('emailSubject').value;
            const content = document.getElementById('emailContent').value;

            if (!recipients || !subject || !content) {
                alert('Veuillez remplir tous les champs de l\'email');
                return;
            }

            try {
                const response = await fetch('/send-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        recipients: recipients.split(',').map(email => email.trim()),
                        subject: subject,
                        content: content
                    }),
                    credentials: 'include'
                });
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                alert('Email envoy√© avec succ√®s !');
            } catch (error) {
                console.error('Erreur:', error);
                alert(`Erreur lors de l'envoi de l'email: ${error.message}`);
            }
        });


       

    </script>
</body>
</html>





